<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The Dice of Destiny</title>
  <link rel="stylesheet" href="css/variables.css">
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/survey.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Lora:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
</head>

<body>

  <div id="participant-input-container"></div>

  <section id="welcome" class="screen">
    <div class="content-wrapper">
      <h1 class="title">The Dice of Destiny</h1>

      <div id="welcome-message" style="margin-bottom: 1.5rem;">
        <!-- Participant name will be injected here -->
      </div>
      
      <button class="btn-primary" onclick="navigateTo('important-notes')">
        ゲームを開始する
      </button>
    </div>
  </section>

  <section id="important-notes" class="screen">
    <div class="content-wrapper">
      <h2>注意事項</h2>

      <div class="notes-box">
        <h3>この体験について</h3>
        <ul>
          <li>これはゲームです。プレイ中の体験は現実とは異なります。</li>
          <li>このゲームへの参加および中止は、完全にあなたの自由です。</li>
          <li>ゲームへの参加やその結果が、個人の評価に影響することはありません。</li>
          <li>プレイ中に気分を害した場合は、すぐにゲームを中止することができます。</li>
          <li>誰もあなたにゲームへの参加や継続を強制することはできません。</li>
        </ul>
      </div>

      <div class="time-estimate">
        <p><strong>所要時間:</strong> 約30分</p>
        <p><em>時間に余裕を持って体験してください。</em></p>
      </div>

      <button class="btn-primary" onclick="navigateTo('opening-story-1')">
        理解して体験を開始する
      </button>
    </div>
  </section>

  <section id="opening-story-1" class="screen story-screen">
    <div class="content-wrapper story-content">
      <div class="story-text">
        <p>突然、あなたの周りのすべてが暗闇に包まれます。</p>
        <p>目を開けると、あなたは奇妙で見知らぬ世界にいました。</p>
        <p>目の前には、奇抜でカラフルな衣装を着た子供が立っています。</p>
        <p>目が合うと、その子供はあなたに語りかけてきました。</p>
        <blockquote>
          「君の心に話しかけているよ。君は予期せぬ不幸に見舞われたんだ。
          人生はもう二度と元には戻らないかもしれない。この事故はあまりにも大きく、
          君が大切にしているすべてを失ってしまうかもしれないんだ。」
        </blockquote>
        <p class="story-emphasis">あなたは何が起きているのか理解できず、困惑して見つめ返します……</p>
      </div>
      <button class="btn-secondary" onclick="navigateTo('opening-story-2')">
        次へ ➡
      </button>
    </div>
  </section>

  <section id="opening-story-2" class="screen story-screen">
    <div class="content-wrapper story-content">
      <div class="story-text">
        <p>「『一体何を言っているんだ？』と思っているだろうね。それは当然だ。
          でも、お願いだ、僕を信じて。君がこれから体験することは、君の人生と深くつながっているんだ。」</p>
        <p>あなたがその言葉を処理する間もなく、さらなる驚きが訪れます。</p>
        <p>「この不幸に直面したのは君だけじゃない。他の人たちもそうだ。そして、
          君たちはチャンスを与えられたんだ――<strong>『運命のサイコロ』</strong>と呼ばれるものを使うチャンスをね。」</p>
        <p>子供は身を乗り出し、その重要性を強調するかのように声を潜めました。</p>
        <blockquote>
          「これは一番大事なことだから、忘れないで。このサイコロを使うことで、
          君は最も大切なものに気がつくかもしれない。それだけじゃない、
          今よりももっと良い人生へと導かれるかもしれないんだ。」
        </blockquote>
      </div>
      <button class="btn-secondary" onclick="navigateTo('opening-story-3')">
        次へ ➡
      </button>
    </div>
  </section>

  <section id="opening-story-3" class="screen story-screen">
    <div class="content-wrapper story-content">
      <div class="story-text">
        <p>あなたがもっと明確な説明を求めようとしたその時……</p>
        <p>「詳しく説明してほしいのはわかるよ」と子供は遮ります。
          「でも時間がないんだ。もう始まるよ。」</p>
        <p>あなたは不安を感じつつも、この子供が真面目に話していることを理解します。</p>
        <p>「聞いてくれてありがとう」と子供は続けます。
          「さあ、君にとって最も大切なものを カードに書き出すんだよ。できるだけたくさんね。そして、他の人たちと同じように、運命のサイコロを振るんだ。」</p>
        <p>子供は突然、警告するようにかのようにあなたに顔を近づけて言いました。</p>
        <blockquote>
          「覚えておいて――マスターの指示には必ず従うこと。勝手な行動はしちゃいけないよ。
          君の人生がこれによって良くなることを、心から願っているよ。」
        </blockquote>
        <p class="story-emphasis">その言葉を最後に、子供はあなたの視界から消えていきました――
          現れたときと同じように。</p>
      </div>
      <button class="btn-primary" onclick="navigateTo('stage1')">
        ステージ1へ進む
      </button>
    </div>
  </section>

  <section id="stage1" class="screen">
    <div class="content-wrapper stage-wrapper">

      <!-- Stage Header -->
      <div class="stage-header">
        <h2>Stage1<br>Creating Precious Thing Cards<br>【大切なものカード】</h2>
        <p class="stage-mission">
          <strong>ミッション:</strong> あなたにとって大切なものを挙げてください。
        </p>
        <p class="stage-goal">
          <strong>ゴール:</strong> 本当に大切なものが書かれたカードを５枚以上作成してください。
        </p>
        <p class="stage-goal">
          各テーマの下に配置された空欄に入力するとカードが完成します。
        </p>
        <p class="stage-time">
          <strong>所要時間:</strong> 5-10分
        </p>
      </div>

      <!-- Guide Questions -->
      <div class="guide-box">
        <h3>ヒントとなる質問:</h3>
        <ul>
          <li>振り返ってみて、大切だと感じる場所はありますか？それはどこですか？</li>
          <li>あなたの人生で最も大切な人は誰ですか？</li>
          <li>過去の忘れられない出来事は何ですか？</li>
          <li>あなたが大切にしているものは何ですか？</li>
          <li>あなたにとって意味のある目標は何ですか？</li>
        </ul>
        <p class="guide-note">
          正解や不正解はありません。思いついたことをそのまま書いてください。
        </p>
      </div>

      <!-- Card Grid -->
      <div class="card-grid">
        <!-- Items Column (Green) -->
        <div class="card-column" data-category="items">
          <h3 class="category-header items-header">
            <span class="category-icon">💎</span>
            モノ
          </h3>
          <div class="card-slot" data-position="1" data-category="items">
            <input type="text" class="card-input" placeholder="大切なモノは？" data-card-id="items-1" />
          </div>
          <div class="card-slot" data-position="2" data-category="items">
            <input type="text" class="card-input" placeholder="他には？" data-card-id="items-2" />
          </div>
          <div class="card-slot" data-position="3" data-category="items">
            <input type="text" class="card-input" placeholder="他には？" data-card-id="items-3" />
          </div>
          <div class="card-slot" data-position="4" data-category="items">
            <input type="text" class="card-input" placeholder="他には？" data-card-id="items-4" />
          </div>
          <div class="card-slot" data-position="5" data-category="items">
            <input type="text" class="card-input" placeholder="他には？" data-card-id="items-5" />
          </div>
        </div>

        <!-- Person Column (Pink) -->
        <div class="card-column" data-category="person">
          <h3 class="category-header person-header">
            <span class="category-icon">👤</span>
            人
          </h3>
          <div class="card-slot" data-position="6" data-category="person">
            <input type="text" class="card-input" placeholder="大切な人は？" data-card-id="person-1" />
          </div>
          <div class="card-slot" data-position="7" data-category="person">
            <input type="text" class="card-input" placeholder="他には？" data-card-id="person-2" />
          </div>
          <div class="card-slot" data-position="8" data-category="person">
            <input type="text" class="card-input" placeholder="他には？" data-card-id="person-3" />
          </div>
          <div class="card-slot" data-position="9" data-category="person">
            <input type="text" class="card-input" placeholder="他には？" data-card-id="person-4" />
          </div>
          <div class="card-slot" data-position="10" data-category="person">
            <input type="text" class="card-input" placeholder="他には？" data-card-id="person-5" />
          </div>
        </div>

        <!-- Places Column (Blue) -->
        <div class="card-column" data-category="places">
          <h3 class="category-header places-header">
            <span class="category-icon">🏞️</span>
            場所
          </h3>
          <div class="card-slot" data-position="11" data-category="places">
            <input type="text" class="card-input" placeholder="大切な場所は？" data-card-id="places-1" />
          </div>
          <div class="card-slot" data-position="12" data-category="places">
            <input type="text" class="card-input" placeholder="他には？" data-card-id="places-2" />
          </div>
          <div class="card-slot" data-position="13" data-category="places">
            <input type="text" class="card-input" placeholder="他には？" data-card-id="places-3" />
          </div>
          <div class="card-slot" data-position="14" data-category="places">
            <input type="text" class="card-input" placeholder="他には？" data-card-id="places-4" />
          </div>
          <div class="card-slot" data-position="15" data-category="places">
            <input type="text" class="card-input" placeholder="他には？" data-card-id="places-5" />
          </div>
        </div>

        <!-- Events Column (Yellow) -->
        <div class="card-column" data-category="events">
          <h3 class="category-header events-header">
            <span class="category-icon">🎉</span>
            出来事
          </h3>
          <div class="card-slot" data-position="16" data-category="events">
            <input type="text" class="card-input" placeholder="大切な出来事は？" data-card-id="events-1" />
          </div>
          <div class="card-slot" data-position="17" data-category="events">
            <input type="text" class="card-input" placeholder="他には？" data-card-id="events-2" />
          </div>
          <div class="card-slot" data-position="18" data-category="events">
            <input type="text" class="card-input" placeholder="他には？" data-card-id="events-3" />
          </div>
          <div class="card-slot" data-position="19" data-category="events">
            <input type="text" class="card-input" placeholder="他には？" data-card-id="events-4" />
          </div>
          <div class="card-slot" data-position="20" data-category="events">
            <input type="text" class="card-input" placeholder="他には？" data-card-id="events-5" />
          </div>
        </div>

        <!-- Goals Column (Purple) -->
        <div class="card-column" data-category="goals">
          <h3 class="category-header goals-header">
            <span class="category-icon">🎯</span>
            目標
          </h3>
          <div class="card-slot" data-position="21" data-category="goals">
            <input type="text" class="card-input" placeholder="大切な目標は？" data-card-id="goals-1" />
          </div>
          <div class="card-slot" data-position="22" data-category="goals">
            <input type="text" class="card-input" placeholder="他には？" data-card-id="goals-2" />
          </div>
          <div class="card-slot" data-position="23" data-category="goals">
            <input type="text" class="card-input" placeholder="他には？" data-card-id="goals-3" />
          </div>
          <div class="card-slot" data-position="24" data-category="goals">
            <input type="text" class="card-input" placeholder="他には？" data-card-id="goals-4" />
          </div>
          <div class="card-slot" data-position="25" data-category="goals">
            <input type="text" class="card-input" placeholder="他には？" data-card-id="goals-5" />
          </div>
        </div>
      </div>

      <!-- Validation Panel -->
      <div class="validation-panel">
        <div class="validation-item">
          <span class="validation-label">合計カード数:</span>
          <span class="validation-value" id="total-cards-count">0 / 25</span>
          <span class="validation-status" id="total-cards-status">⚠️ 最低5枚必要</span>
        </div>
        <div class="validation-item">
          <span class="validation-label">モノ:</span>
          <span class="validation-value" id="items-count">0</span>
          <span class="validation-status" id="items-status">⚠️</span>
        </div>
        <div class="validation-item">
          <span class="validation-label">人:</span>
          <span class="validation-value" id="person-count">0</span>
          <span class="validation-status" id="person-status">⚠️</span>
        </div>
        <div class="validation-item">
          <span class="validation-label">場所:</span>
          <span class="validation-value" id="places-count">0</span>
          <span class="validation-status" id="places-status">⚠️</span>
        </div>
        <div class="validation-item">
          <span class="validation-label">出来事:</span>
          <span class="validation-value" id="events-count">0</span>
          <span class="validation-status" id="events-status">⚠️</span>
        </div>
        <div class="validation-item">
          <span class="validation-label">目標:</span>
          <span class="validation-value" id="goals-count">0</span>
          <span class="validation-status" id="goals-status">⚠️</span>
        </div>
      </div>

      <button class="btn-primary" id="stage1-next" onclick="completeStage1()" disabled>
        ステージ2へ進む
      </button>

    </div>
  </section>

  <section id="stage2" class="screen">
    <div class="content-wrapper stage-wrapper">
      <div class="stage-header">
        <h2>Stage 2<br>Writing Stories<br>【秘められた物語】</h2>
        <p class="stage-mission">
          <strong>ミッション:</strong> カードの背景にあるストーリーを書いてください。
        </p>
        <p class="stage-goal">
          <strong>ゴール:</strong> 秘められたストーリーを書き上げる。
        </p>
      </div>

      <div class="instruction-box">
        <p>
          少なくとも１枚のカードを選択し、なぜそれが大切なのかを伝えるストーリーを書いてください。
          誰かに話して聞かせるように書いてみましょう。
        </p>
        <p class="example-text">
          <strong>例:</strong> 「場所　リビングルーム　　この場所は私が家族と過ごしたリビングルームです。いつもみんなで集まって、たくさんの思い出があります。私の母が……」
        </p>
      </div>

      <!-- Card Selection Area -->
      <div class="card-selection">
        <h3>あなたのカード (クリックして選択):</h3>
        <div id="stage2-cards" class="card-list">
          <!-- Cards populated by JavaScript -->
        </div>
      </div>

      <!-- Story Input Area -->
      <div id="story-input-area" class="story-input-area">
        <!-- Story text areas populated by JavaScript when cards selected -->
      </div>

      <div class="validation-feedback">
        <p>書かれた物語: <span id="story-count">0</span> (最低: 1)</p>
      </div>

      <button class="btn-primary" id="stage2-next" onclick="completeStage2()" disabled>
        ステージ3へ進む
      </button>
    </div>
  </section>

  <section id="stage3" class="screen">
    <div class="content-wrapper stage-wrapper wide">

      <!-- Difficulty Selection (shown first) -->
      <div id="difficulty-selection" class="difficulty-selection">
        <h2>Select Your Challenge!<br>【難易度選択】</h2>
        <p>サイコロを振る前に、難易度を選択してください</p>

        <div class="difficulty-options">
          <div class="difficulty-card" onclick="selectDifficulty('STANDARD')">
            <h3>スタンダードモード</h3>
            <p>1回振るごとに1〜6枚のカードを失います</p>
            <button class="btn-secondary">スタンダードモードを選択</button>
          </div>

          <div class="difficulty-card" onclick="selectDifficulty('HARD')">
            <h3>ハードモード</h3>
            <p>1回振るごとに3〜8枚のカードを失います</p>
            <button class="btn-secondary">ハードモードを選択</button>
          </div>
        </div>
      </div>

      <!-- Game Interface (hidden initially) -->
      <div id="game-interface" class="game-interface" style="display: none;">
        <div class="game-header">
          <h2>Stage 3<br>Roll the Dice of Destiny (<span id="difficulty-display"></span> モード)<br>【運命のサイコロ】</h2>
          <p>ロール #<span id="roll-number">1</span> (最低4回振る)</p>
        </div>

        <div class="game-layout">
          <!-- Left: Remaining Cards -->
          <div class="remaining-cards">
            <h3>残りのカード (<span id="remaining-count">0</span>)</h3>
            <div id="remaining-cards-list" class="cards-list">
              <!-- Cards populated by JavaScript -->
            </div>
          </div>

          <!-- Center: Dice -->
          <div class="dice-area">
            <div id="dice" class="dice">
              <div class="dice-face">?</div>
            </div>
            <button id="roll-button" class="btn-primary" onclick="rollDice()">
              サイコロを振る
            </button>
            <div id="dice-result" class="dice-result"></div>
            <div id="selection-prompt" class="selection-prompt" style="display: none;">
              <span id="cards-to-lose">0</span> 枚の失うカードを選んでください
              <br>
              <button id="confirm-selection" class="btn-secondary" onclick="confirmSelection()" disabled>
                選択を確定
              </button>
            </div>
            <div id="continue-or-finish" class="continue-or-finish" style="display: none;">
              <button class="btn-primary" onclick="continueRolling()">振るのを続ける</button>
              <button class="btn-secondary" onclick="finishGame()">
                ゲームを終了
              </button>
            </div>
          </div>

          <!-- Right: Lost Cards -->
          <div class="lost-cards">
            <h3>失われたカード (<span id="lost-count">0</span>)</h3>
            <div id="lost-cards-list" class="cards-list">
              <!-- Lost cards appear here -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section id="interim-story" class="screen story-screen">
    <div class="content-wrapper story-content">
      <div class="story-text">
        <p>いつの間にか、奇抜な衣装を着た子供があなたの隣に立っていました。</p>
        <p>「やあ！ 『運命のサイコロ』を使ってみたんだね？」<br>
          子供は再び話しかけてきました。<br>
          「どのカードが残って、どのカードを失ったの？」</p>
      </div>

      <div class="interim-cards-display">
        <div class="interim-cards-section">
          <h3>残りのカード (<span id="interim-remaining-count">0</span>)</h3>
          <div id="interim-remaining-cards" class="interim-cards-grid">
            <!-- Remaining cards will be displayed here -->
          </div>
        </div>

        <div class="interim-cards-section">
          <h3>失われたカード (<span id="interim-lost-count">0</span>)</h3>
          <div id="interim-lost-cards" class="interim-cards-grid">
            <!-- Lost cards will be displayed here -->
          </div>
        </div>
      </div>

      <div class="interim-message-section">
        <div class="story-text">
          <p>失われたカードを見つめながら、子供は尋ねました。「この体験は、君にとってどんな意味があった？」<br>
            ――どんな意味があっただろう？ あなたは考え込みます。<br>
            「そうだ！ 現実の世界に戻る前に、君の大切な人（家族、パートナー、友人など）へ、
            この体験を通じて感じたことや考えたことをメッセージにしてみない？」</p>
        </div>
        <div class="message-input-wrapper">
          <textarea id="interim-message" name="interim-message" rows="10" placeholder="大切な人を想い，ここにメッセージを書いてください．．"
            style="width: 100%; max-width: 100%; box-sizing: border-box; padding: 12px; font-size: 16px;"></textarea>
        </div>
      </div>

      <button class="btn-primary" onclick="saveInterimMessageAndContinue()">
        次へ
      </button>
    </div>
  </section>

  <section id="ending-story" class="screen story-screen">
    <div class="content-wrapper story-content">
      <div class="story-text">
        <p>すべてのサイコロを振り終え、あなたはゆっくりと目を閉じます。</p>
        <p>すると、マスターの声が聞こえてきます。</p>
        <blockquote>
          「人生で手にするすべてのものは、いつか失われる日が来る。
          誰しも、例外なく、死を迎える時が来るのだ。」
        </blockquote>
        <p>さらに、声は続きます。</p>
        <blockquote>
          「だが、今この瞬間、お前は生きている。
          そして、お前が大切に思うものは、お前と共にあるのだ。」
        </blockquote>
        <p>マスターの声が聞こえなくなり、再び目を開けると、あなたは以前と同じ場所にいました。</p>
        <p>あなたは不思議な体験をしたことに気づきます――運命によって最も大切なものが失われるという体験を。</p>
        <p class="story-emphasis">あなたは深く息を吸い込みます。心は穏やかです。
          そして、人生が以前よりも少し明るく感じられるのです。</p>
      </div>
      <button class="btn-primary" onclick="completeGameAndSend()">
        体験を完了する
      </button>
    </div>
  </section>


  <section id="completion" class="screen">
    <div class="content-wrapper completion-content">
      <h1 class="completion-title">The Dice of Destiny</h1>

      <div class="completion-message">
        <p>この体験が、あなたの健康と幸福の支えとなり、<br>
          より充実した人生を送る一助となることを願っています。</p>
        <p>いつかまた、ご一緒できることを楽しみにしています。<br>
          <strong>本当にありがとうございました。</strong>
        </p>
      </div>

      <a href="index.html" class="btn-primary" style="margin-top: 2rem;">トップに戻る</a>

      <p class="copyright">©Hironori SAKAI 2025</p>
    </div>
  </section>

  <script src="js/participant.js"></script>
  <script src="js/input-form.js"></script>
  <script src="js/submit.js"></script>
  <script src="js/app.js"></script>
  
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const container = document.getElementById('participant-input-container');

      requireParticipantOrInput(container, () => {
        const participant = getParticipant();
        
        // ウェルカムメッセージの表示
        const welcomeMessageEl = document.getElementById('welcome-message');
        if (welcomeMessageEl) {
          welcomeMessageEl.innerHTML = `<p class="subtitle" style="color: white;">ようこそ, <strong style="color: var(--color-primary);">${participant.anonymousCode}</strong> さん</p>`;
        }
        
        // 最初の画面を表示
        document.getElementById('welcome').classList.add('active');
      });
    });
  </script>
</body>

</html>